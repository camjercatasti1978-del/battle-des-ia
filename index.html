<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="JERCAT Trading Bot - Strat√©gie Hybride de Trading Crypto sur BSC">
    <title>ü§ñ JERCAT Trading Bot - HYBRID EXIT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .glass-effect {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            backdrop-filter: blur(10px);
            border: 1px solid #334155;
        }
        .gradient-text {
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 1000% 1000%;
            animation: gradient 30s linear infinite;
            font-weight: 900;
        }
        @keyframes gradient {
            0% { background-position: 0% center; }
            100% { background-position: 1000% center; }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- En-t√™te -->
        <div class="glass-effect rounded-2xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-black gradient-text mb-2">ü§ñ JERCAT HYBRID EXIT</h1>
                    <p class="text-gray-400 text-sm">‚ö° Connexion Auto JERCAT ‚Ä¢ üéØ Strat√©gie Hybride ‚Ä¢ üî• Trailing Stop</p>
                    <p class="text-green-400 font-bold text-xs mt-2">‚úÖ AUTO-VALIDATION - Transactions automatiques</p>
                    <p class="text-yellow-400 font-bold text-xs mt-1">üíµ Trading USDT ‚Ä¢ üéØ TP/SL Dynamiques ‚Ä¢ üíé Frais: 0.001 BNB</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="openJercatWallet()" class="flex items-center gap-2 px-4 py-2 rounded-xl font-semibold shadow-lg text-sm" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000;">
                        <span>ü§ñ</span><span>JERCAT Wallet</span>
                    </button>
                    <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-4 py-2 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-sm">
                        <span>üëõ</span><span id="walletText">MetaMask</span>
                    </button>
                    <button onclick="togglePrivateKeyModal()" class="flex items-center gap-2 px-4 py-2 rounded-xl font-semibold bg-gradient-to-r from-blue-500 to-cyan-500 text-sm">
                        <span>üîë</span><span>Cl√© Priv√©e</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Cl√© Priv√©e -->
        <div id="privateKeyModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-6 max-w-md w-full border-2 border-red-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-red-400">‚ö†Ô∏è Cl√© Priv√©e</h3>
                    <button onclick="togglePrivateKeyModal()" class="text-2xl hover:text-red-400">‚úï</button>
                </div>
                <div class="bg-red-500/20 border border-red-500 rounded-lg p-4 mb-4">
                    <p class="text-sm text-red-300"><strong>ATTENTION:</strong> Ne partagez JAMAIS votre cl√© priv√©e.</p>
                </div>
                <input type="password" id="privateKeyInput" placeholder="0x..." class="w-full glass-effect rounded-lg px-4 py-3 border-2 border-gray-600 font-mono text-sm text-white mb-4">
                <button onclick="connectWithPrivateKey()" class="w-full px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 rounded-lg font-semibold">
                    üîì Connecter
                </button>
            </div>
        </div>

        <!-- Console de debug -->
        <div class="glass-effect rounded-xl p-4 mb-6 border-2" style="border-color: #f59e0b;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" style="color: #f59e0b;">üîç Console</h3>
                <button onclick="clearDebugLog()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold">üóëÔ∏è Effacer</button>
            </div>
            <div id="debugConsole" class="bg-black/70 rounded-lg p-4 h-48 overflow-y-auto font-mono text-xs" style="border: 1px solid #f59e0b;">
                <p style="color: #f59e0b;">‚úÖ JERCAT Bot HYBRID EXIT initialis√©</p>
                <p style="color: #10b981;">üíµ Mode USDT activ√©</p>
                <p style="color: #3b82f6;">üéØ Strat√©gie: TP/SL + Indicateurs + Trailing Stop</p>
                <p style="color: #f59e0b;">üíé Frais JERCAT: 0.001 BNB par trade</p>
            </div>
        </div>

        <!-- Infos Strat√©gie -->
        <div class="glass-effect rounded-xl p-4 mb-6 border-2 border-blue-500">
            <h3 class="text-xl font-bold mb-3 text-blue-400">üéØ Strat√©gie de Sortie HYBRIDE</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="bg-red-500/20 border border-red-500 rounded-lg p-3">
                    <p class="font-bold text-red-400 mb-1">üõ°Ô∏è S√âCURIT√â</p>
                    <p class="text-xs text-gray-300">‚Ä¢ Stop Loss: -ATR √ó 1.5</p>
                    <p class="text-xs text-gray-300">‚Ä¢ Trailing Stop: -50% du max</p>
                    <p class="text-xs text-gray-300">‚Ä¢ D√©tection de dump</p>
                </div>
                <div class="bg-green-500/20 border border-green-500 rounded-lg p-3">
                    <p class="font-bold text-green-400 mb-1">üí∞ TAKE PROFIT</p>
                    <p class="text-xs text-gray-300">‚Ä¢ Minimum: 3%</p>
                    <p class="text-xs text-gray-300">‚Ä¢ Standard: ATR √ó 3</p>
                    <p class="text-xs text-gray-300">‚Ä¢ Big: 10%+</p>
                </div>
                <div class="bg-blue-500/20 border border-blue-500 rounded-lg p-3">
                    <p class="font-bold text-blue-400 mb-1">üìä INDICATEURS</p>
                    <p class="text-xs text-gray-300">‚Ä¢ 5 signaux analys√©s</p>
                    <p class="text-xs text-gray-300">‚Ä¢ 3/5 = Sortie</p>
                    <p class="text-xs text-gray-300">‚Ä¢ EMA, RSI, MACD, BB, Vol</p>
                </div>
            </div>
        </div>

        <!-- S√©lecteur Crypto -->
        <div id="cryptoSelector" class="glass-effect rounded-xl p-4 mb-6 border border-gray-500">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Crypto</label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full glass-effect rounded-lg px-4 py-3 border-2 border-gray-600 text-lg font-semibold cursor-pointer text-white">
                        <option>Chargement...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode Trading</label>
                    <div class="w-full glass-effect rounded-lg px-4 py-3 border-2 text-lg font-semibold text-center" style="border-color: #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.2));">
                        <span style="color: #f59e0b;">ü§ñ JERCAT HYBRID EXIT (USDT)</span>
                    </div>
                </div>
            </div>
            
            <!-- Token personnalis√© -->
            <div class="border-t-2 border-gray-700 pt-4 mt-4">
                <label class="block text-sm text-gray-400 mb-2">üîç <span class="font-bold">Token personnalis√©</span> (adresse contrat BSC):</label>
                <div class="flex gap-3">
                    <input type="text" id="customTokenAddress" placeholder="0x..." class="flex-1 glass-effect rounded-lg px-4 py-3 border-2 border-gray-600 font-mono text-sm text-white">
                    <button onclick="addCustomToken()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 rounded-lg font-semibold whitespace-nowrap">
                        ‚úÖ V√©rifier
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">üí° Exemple: 0x197CF8951d93325A9333857Ee5330daF7aC4bcCF (JERCAT)</p>
                
                <div id="customTokenInfo" class="hidden mt-4 glass-effect rounded-lg p-4 border-2 border-green-500">
                    <div class="flex items-center justify-between flex-wrap gap-3">
                        <div class="flex-1 min-w-[200px]">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">‚úÖ</span>
                                <div>
                                    <p class="font-bold text-xl text-green-400" id="customTokenSymbol">-</p>
                                    <p class="text-sm text-gray-400" id="customTokenName">-</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 font-mono break-all" id="customTokenAddr">-</p>
                            <p class="text-sm text-gray-400 mt-2">D√©cimales: <span class="text-white font-bold" id="customTokenDecimals">-</span></p>
                        </div>
                        <button onclick="useCustomToken()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-lg font-semibold whitespace-nowrap">
                            üöÄ Trader
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capital -->
        <div id="capitalSection" class="glass-effect rounded-xl p-4 mb-6 border-2" style="border-color: #f59e0b;">
            <h3 class="text-xl font-bold mb-4" style="color: #f59e0b;">üí∞ Capital (USDT)</h3>
            <div class="flex gap-4">
                <input type="number" id="capitalInput" placeholder="Ex: 100" value="100" class="flex-1 glass-effect rounded-lg px-4 py-3 border-2 border-gray-600 text-white">
                <button onclick="setCapital()" class="px-8 py-3 rounded-lg font-semibold" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000;">
                    ‚úÖ D√©finir
                </button>
            </div>
        </div>

        <!-- Statistiques -->
        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="glass-effect rounded-xl p-4 border-2" style="border-color: #f59e0b;">
                <p class="text-xs text-gray-400">Capital</p>
                <p class="text-2xl font-bold" style="color: #f59e0b;"><span id="capitalDisplay">0</span> <span class="text-sm">USDT</span></p>
            </div>
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Prix</p>
                <p class="text-2xl font-bold text-white">$<span id="currentPrice">...</span></p>
            </div>
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Profit</p>
                <p class="text-2xl font-bold text-green-400"><span id="profitDisplay">0</span> <span class="text-sm">USDT</span></p>
            </div>
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Win Rate</p>
                <p class="text-2xl font-bold text-white" id="winRateDisplay">0%</p>
            </div>
            <div class="glass-effect rounded-xl p-4 border-2 border-purple-500">
                <p class="text-xs text-gray-400">Max Profit</p>
                <p class="text-2xl font-bold text-purple-400"><span id="maxProfitDisplay">0</span>%</p>
            </div>
        </div>

        <!-- Signaux -->
        <div class="glass-effect rounded-xl p-4 mb-6 border border-gray-500">
            <h3 class="text-xl font-bold mb-4" style="color: #f59e0b;">‚ö° Signaux Entr√©e (‚â•60%)</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-trend">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">EMA</span>
                        <span class="text-2xl" id="signal-trend-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="trend-display">--</p>
                </div>
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-rsi">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">RSI</span>
                        <span class="text-2xl" id="signal-rsi-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="rsi-display">--</p>
                </div>
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-macd">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">MACD</span>
                        <span class="text-2xl" id="signal-macd-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="macd-display">--</p>
                </div>
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-bollinger">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">BB</span>
                        <span class="text-2xl" id="signal-bollinger-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="bollinger-display">--</p>
                </div>
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-volume">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">Volume</span>
                        <span class="text-2xl" id="signal-volume-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="volume-display">--</p>
                </div>
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-volatility">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">ATR</span>
                        <span class="text-2xl" id="signal-volatility-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="volatility-display">--</p>
                </div>
            </div>

            <div class="rounded-xl p-4 border-2" style="background: linear-gradient(to right, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.2)); border-color: #f59e0b;">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-lg font-bold text-white">
                        Score BUY: <span style="color: #f59e0b;" class="text-2xl" id="signal-score">0%</span>
                    </p>
                </div>
                <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-300" id="signal-progress" style="width: 0%; background: linear-gradient(to right, #dc2626, #fbbf24, #f59e0b);"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center" id="signal-status">En attente...</p>
            </div>

            <!-- Signaux de Sortie -->
            <div class="mt-4 rounded-xl p-4 border-2 border-red-500" style="background: linear-gradient(to right, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));">
                <h4 class="text-lg font-bold text-red-400 mb-3">üî¥ Signaux de Sortie (3/5 = SELL)</h4>
                <div class="grid grid-cols-5 gap-2 text-xs">
                    <div class="text-center">
                        <p class="text-gray-400">EMA‚Üì</p>
                        <p class="text-2xl" id="exit-ema">‚ö™</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">RSI>70</p>
                        <p class="text-2xl" id="exit-rsi">‚ö™</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">MACD‚úó</p>
                        <p class="text-2xl" id="exit-macd">‚ö™</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">BB‚Üë</p>
                        <p class="text-2xl" id="exit-bb">‚ö™</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">Vol‚Üì</p>
                        <p class="text-2xl" id="exit-vol">‚ö™</p>
                    </div>
                </div>
                <p class="text-center mt-2 font-bold text-red-300" id="exit-score">Score: 0/5</p>
            </div>
        </div>

        <!-- Graphique & Contr√¥les -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-effect rounded-xl p-4 border border-gray-500">
                    <h2 class="text-xl font-bold mb-4" style="color: #f59e0b;">üìà Graphique</h2>
                    <div class="h-48">
                        <canvas id="tradingChart"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-xl p-4 border border-gray-500">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" style="color: #f59e0b;">üìã Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">Start</span>
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö°</span>
                            <p>Aucun trade</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-effect rounded-xl p-4 border border-gray-500">
                    <h2 class="text-xl font-bold mb-4" style="color: #f59e0b;">‚öôÔ∏è Param√®tres</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">% par trade</label>
                            <input type="number" id="tradePercent" value="10" min="1" max="100" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">TP Multiplier</label>
                            <input type="number" id="tpMultiplier" value="3" min="2" max="5" step="0.5" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">SL Multiplier</label>
                            <input type="number" id="slMultiplier" value="1.5" min="1" max="3" step="0.25" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Score min BUY (%)</label>
                            <input type="number" id="minScore" value="60" min="50" max="100" step="5" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Min Exit Signals</label>
                            <input type="number" id="minExitSignals" value="3" min="2" max="5" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div class="rounded-lg p-3 border-2" style="background: rgba(245, 158, 11, 0.2); border-color: #f59e0b;">
                            <p class="text-xs font-bold" style="color: #f59e0b;">‚úÖ Profit min: 3%</p>
                            <p class="text-xs font-bold text-purple-400">üéØ Trailing: -50% du max</p>
                            <p class="text-xs font-bold text-yellow-400">üíé Frais: 0.001 BNB</p>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-xl p-4 border border-gray-500">
                    <h3 class="text-lg font-bold mb-3" style="color: #f59e0b;">üìä Statut</h3>
                    <div class="space-y-2 text-sm">
                        <p>Wallet: <span id="walletStatus" class="text-red-400">üî¥ Non</span></p>
                        <p>Mode: <span id="modeStatus" class="text-gray-400">--</span></p>
                        <p>Position: <span id="positionStatus" class="text-gray-400">‚ö™ None</span></p>
                        <p>Trades: <span id="tradesCount" class="text-white">0</span></p>
                        <p>Auto-Valid: <span id="jercatStatus" style="color: #f59e0b;">‚è≥ En attente...</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const JERCAT_WALLET = '0x7C08b7E9862bd3826c0de1741a2d26770C39903d';
        const JERCAT_FEE_BNB = '0.001';
        const BSC_RPCS = ['https://bsc-dataseed.binance.org', 'https://bsc-dataseed1.defibit.io'];
        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };
        const WBNB = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';
        const USDT = '0x55d398326f99059fF775485246999027B3197955';
        const USDT_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function balanceOf(address account) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];
        const TOKEN_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function balanceOf(address account) view returns (uint256)',
            'function decimals() view returns (uint8)',
            'function name() view returns (string)',
            'function symbol() view returns (string)'
        ];

        // STATE
        let state = {
            account: null,
            wallet: null,
            provider: null,
            isConnected: false,
            connectionMethod: null,
            selectedCrypto: 'BT
